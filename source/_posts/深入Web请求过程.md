---
title: 深入Web请求过程
date: 2017-10-31 15:18:25
tags:
- Web
- DNS
- CDN
comments: true
categories: 原创
---
# B/S网络架构概述
&nbsp;&nbsp;&nbsp;&nbsp;B/S网络架构都基于统一的应用层协议HTTP来交互数据，HTTP是一种**无状态的短链接**通信。通常一次请求就完成了一次数据交互，然后这次通信链接就断开了。<br>
&nbsp;&nbsp;&nbsp;&nbsp;当一个用户在浏览器里输入一个URL并发送请求时，将会发生很多操作:

&nbsp;&nbsp;&nbsp;&nbsp;首先会请求DNS把域名解析成对应的IP地址，然后根据IP地址在互联网上找到对应的服务器，向这个服务器发起一个Get请求，由这个服务器决定返回默认的数据资源给访问用户。<!-- more --><br>
&nbsp;&nbsp;&nbsp;&nbsp;在服务端还有很多复杂的业务逻辑：服务器可能有很多台，这是需要一个负载均衡设备来平均分配所有用户的请求；还有请求的数据存储在分布式缓存里的还是一个静态文件中，或是在数据库中；当数据返回浏览器时，浏览器解析数据发现还有一些静态资源（如CSS、JS或图片）时又会发起另外一个HTTP请求，而这些请求很可能在CDN上，那么CDN服务器又会处理这个用户的请求。

&nbsp;&nbsp;&nbsp;&nbsp;大体上一个用户请求会涉及这些操作，其中任何一个细节都会影响这个请求最终是否会成功。

---
<br>

# DNS域名解析
&nbsp;&nbsp;&nbsp;&nbsp;发起一个HTTP连接本质上就是建立一个Socket连接，只不过outputStream.write写的二进制字节数据格式要符合HTTP。


## DNS域名解析过程
当一个用户在浏览器输入一个域名后，DNS解析将会有将近10个步骤，过程大体如下：
1. 浏览器会检查**浏览器的缓存**中有没有这个域名对应的解析过的IP地址，如果缓存中有，那么这个域名的解析过程就将结束。
2. 如果浏览器的缓存中没有IP地址，浏览器就会查找**操作系统缓存**中是否有这个域名的DNS解析结果。以上两个步骤都是在本机中完成，还没有涉及真正的域名解析服务器。
3. 如果在本机中无法完成域名的解析，就会真正请求域名服务器来解析这个域名。在我们的网络配置中有“DNS服务器地址”这一项，当在本机中无法完成解析的时候，操作系统会把这个域名发送给网络配置中设置的**LDNS**，也就是本地区的域名服务器。大约80%的域名解析都带这里就可以完成了，所以LDNS承担了主要的域名解析工作。
4. 如果LDNS仍然没有命中，就直接到**Root Server域名服务器**请求解析。
5. 根域名服务器返回给本地域名服务器一个查询域的**主域名服务器**（gTLD Server）地址。gTLD是国级顶级域名服务器，如 .com、.cn等。
6. 本地域名服务器（LDNS）再向上一步返回的gTLD服务器发送请求。
7. 接受请求的gTLD服务器查找并返回此域名对应的**Name Server域名服务器**的地址，这个Name Server通常就是自己注册的域名服务器。例如在某个域名服务提供商申请的域名，那么这个域名解析任务就由这个域名提供商的服务器来完成。
8. Name Server域名服务器会查询存储的域名和IP的映射关系表，在正常情况下都根据域名得到目标IP记录，连同一个TTL值返回给DNS Server域名服务器。
9. 返回该域名对应的IP和TTL值，LDNS会缓存这个域名和IP的对应关系，缓存时间由TTL值控制。
10. 将解析结果返回给用户，用户根据TTL值缓存在本地系统缓存中，域名解析过程结束。

&nbsp;&nbsp;&nbsp;&nbsp;浏览器、操作系统和本地域名服务器的域名缓存**时间和大小**都是有的限制，主要是时间限制，一般为几分钟到几小时不等，一般缓存空间不是影响域名失效的主要因素。
<br>

## 域名解析方式
- **A记录**：A代表的是Address，用来指定域名对应的IP地址。A记录可以将多个域名解析到一个IP地址，但不能将一个域名解析到多个IP地址。
- **MX记录**：表示的是Mail Exchange，就是将某个域名下的邮件服务器指向自己的Mail Server。
- **CNAME记录**：全程是Canonical Name（别名解析）。所谓的别名解析就是可以为一个域名设置一个或多个别名。如将 Hang6.github.io解析到 yhang6.com。其中后者是前者的别名。
- **NS记录**：为某个域名指定DNS解析服务器，也就是这个域名有指定的IP地址的DNS服务器去解析。
- **TXT记录**：为某个主机名或域名设置说明，如可以为 yhang6.com设置TXT记录为“小Hang同学的博客”这样的说明。

---
<br>

# CDN工作机制
&nbsp;&nbsp;&nbsp;&nbsp;CDN就是内容分布网络（Content Delivery Network），是构筑在现有Internet上的一种先进的流量分配网络。其**目的**是通过在现有的Internet中增加一层新的网络架构，将网站的内容发步到最接近用户的网络“边缘”，提高用户访问网站的响应速度。

&nbsp;&nbsp;&nbsp;&nbsp;CDN有别于镜像，它比镜像更加智能，可以有这样一个比喻：**CDN=镜像+缓存+整体负载均衡（GSLB）**。因此，CDN可以明显提高Internet中信息流动的效率。目前CDN都**以缓存网站中的静态数据为主**。用户在从主站服务器请求到动态数据之后，再从CDN上下载静态数据，从而加速网页数据内容的下载速度。

&nbsp;&nbsp;&nbsp;&nbsp;通常CDN要达到以下几个目标：
- 可扩展。分为性能可扩展性和成本可扩展性。
- 安全性。强调提供物理设备、网络、软件、数据和服务过程的安全性。
- 可靠性、响应和执行。服务可用性能能够处理可能的故障和用户体验下降的问题，通过负载均衡及时提供网络的容错机制。
<br>

## 负载均衡
&nbsp;&nbsp;&nbsp;&nbsp;负载均衡（Load Balance）是对工作任务进行平衡、分摊到多个操作单元上执行，如图片服务器、应用服务器等，共同完成工作任务。它可以提高服务器响应速度及利用效率，避免软件或者硬件模块出现单点失效，解决网络拥塞问题，实现地理位置无关性，为用户提供较一致的访问质量。

&nbsp;&nbsp;&nbsp;&nbsp;通常有三种负载均衡架构，分别是**链路负载均衡、集群负载均衡、操作系统负载均衡**。
- 链路负载均衡就是通过DNS解析成不同的IP，然后根据IP访问不同的目标服务器实现的。这种方式的优点就是用户会直接访问目标服务器，速度会很快。但缺点是DNS都有缓存，一旦某台Web Server挂掉，就很难及时更新用户的域名解析结构。
- 集群负载均衡一般分为硬件负载均衡和软件负载均衡。**硬件负载均衡**一般使用一台专门的硬件设备来转发请求，这台设备性能非常好，但是非常昂贵；**软件负载均衡**是使用最普遍的一种负载方式，特点是成本很低，但是一般一次访问请求要经过多次代理服务器，会增加网络延时。
- 操作系统负载均衡就是利用操作系统级别的软中断或者硬件中断来达到负载均衡，如可以设置多队列网卡等来实现。

---
<br>

# 三次握手，四次挥手
## 三次握手
&nbsp;&nbsp;&nbsp;&nbsp;当客户端找到了服务端的IP地址之后，为了准确无误的将数据送达目标处，TCP协议采用三次握手策略建立起连接。用TCP协议将数据包送出去后，TCP一定会向对方确认是否成功送达。
- **第一次握手**：建立连接时，客户端发送syn包（syn=j）到服务器，并进入**SYN_SEND**状态，等待服务器确认。
- **第二次握手**：服务器收到syn包，必须确认客户的SYN（返回ACK包，ack=j+1），同时自己发送一个syn包（syn=k）。即发送SYN+ACK包，此时服务器进入**SYN_RECV**状态。
- **第三次握手**：客户端收到服务器的SYN+ACK包，向服务器发送确认包（ack=k+1），此包发送完毕时，客户端和服务器进入**ESTABLISHED**状态，完成三次握手。

&nbsp;&nbsp;&nbsp;&nbsp;完成三次握手后，客户端与服务器开始传送数据。

## 四次挥手
&nbsp;&nbsp;&nbsp;&nbsp;四次挥手指的是断开TCP连接时（关闭浏览器），需要客户端和服务器发送4个包确认连接的断开。由于TCP连接时**全双工**的，因此每个方向都必须进行单独关闭。**首先进行关闭的一方执行主动关闭，另一方执行被动关闭**。

- **第一次挥手**：主动关闭方发送FIN包进入**FIN_WAIT1**状态。
- **第二次挥手**：被动关闭方收到主动方的FIN并返回一个ACK包，此时被动方进入**CLOSE_WAIT**状态，表示接收到主动方的关闭请求；主动方接收到被动方的ACK包后，进入到**FIN_WAIT2**状态。
- **第三次挥手**：当被动方发送完以前请求的数据包后，向主动方发送FIN包并进入**LAST_ACK**状态。
- **第四次挥手**：主动方接收到FIN包并返回一个ACK包，此时主动方进入**TIME_WAIT**状态，2MSL时间后关闭连接；被动方接收到ACK包后关闭连接。

&nbsp;&nbsp;&nbsp;&nbsp;注意：<br>
&nbsp;&nbsp;&nbsp;&nbsp;FIN报文只表示此方不再发送数据，但是可以接受数据。当客户端发送FIN报文时，说明客户端已经没有要发送的数据，但此时服务器可能还有未返回的请求结果，所以需要服务器发送FIN报文来确认所有数据以传输完成。这是全双工模式的体现，也是为什么需要四次挥手的原因。

---
参考：《深入分析Java Web技术内幕》——许令波
转载请注明出处：[小Hang同学的博客](http://www.yhang6.com/)