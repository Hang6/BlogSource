---
title: MySQL查询性能优化
date: 2017-12-07 20:23:29
tags:
- MySQL
- 性能优化
comments: true
categories: 原创
---

# 慢查询基础：优化数据访问
&nbsp;&nbsp;&nbsp;&nbsp;查询性能低下最基本的原因是访问的数据太多，大部分性能低下的查询都可以通过减少访问的数据量的方式进行优化。对于低效的查询，通过下列两个步骤来分析总是很有效：
1. 确认应用程序是否在检索大量超过需要的数据
2. 确认MySQL服务器层是否在分析大量超过需要的数据行。

## 向数据库请求了不需要的数据
&nbsp;&nbsp;&nbsp;&nbsp;下面是一些典型的案例：<!-- more -->
- 查询不需要的记录
- 多表关联时返回全部列
- 总是取出全部列
- 重复查询相同的数据

## 扫描额外的记录
&nbsp;&nbsp;&nbsp;&nbsp;衡量查询开销的三个指标：
- 响应时间
- 扫描的行数
- 返回的行数

&nbsp;&nbsp;&nbsp;&nbsp;如果发现查询需要扫描大量的行数但只返回少数的行，那么通常使用下面的技巧去优化：
- 使用索引覆盖扫描。把所有需要用的列都放到索引中，这样存储引擎无须回表获取对应行就可以返回结果
- 改变库表结构。
- 重写复杂的查询，让MySQL优化器能够以更优化的方式执行这个查询

---
<br>

# 重构查询的方式
1. 是否需要将一个复杂的查询分成多个简单的查询，这是设计查询时需要考虑的重要问题
2. 切分查询。将大查询切分成小查询，完成的功能一样，但将其拆分为几个次，每次完成一小部分任务
3. 分解关联查询。将一条查询分解为多条查询，但返回同样的结果。

&nbsp;&nbsp;&nbsp;&nbsp;用**分解关联查询**的方式重构查询有如下优势：
- 让缓存的效率更高
- 将查询分解后，执行单个查询可以减少锁竞争
- 在应用层做关联，可以更容易对数据库进行拆分，更容易做到高性能和可扩展
- 查询本身效率可能有所提升
- 减少冗余记录的查询

---
<br>

# 查询执行基础
&nbsp;&nbsp;&nbsp;&nbsp;MySQL查询执行路径：
1. 客户端发送一条查询给服务器
2. 服务器先检查查询缓存，如果命中缓存，则立即返回查询结果；如果未命中，进入下一阶段
3. 服务器进行SQL解析、预处理，再由优化器生成对应的执行计划
4. MySQL根据优化器生成的执行计划，调用存储引擎的API来执行查询
5. 将结果返回给客户端

## 查询优化器
&nbsp;&nbsp;&nbsp;&nbsp;一条查询可以有很多种执行方式，最后返回的结果都相同。优化器的作用就是找到其中最好的执行计划，但是由于多种原因，优化器选择的执行计划也并不总是最优的。

&nbsp;&nbsp;&nbsp;&nbsp;查询优化器有很多优化策略来生成一个最优的执行计划。优化策略可以分为两种，一种是静态优化，另一种是动态优化。
- **静态优化**：静态优化可以直接对解析树进行分析，并完成优化。静态优化不依赖于特别的数值，它在第一次完成后就一直有效，即使使用不同的参数重复执行查询也不会发生变化。可以认为这是一种“编译时优化”。
- **动态优化**：动态优化和上下文有关，也可其他很多因素有关。它需要在每次查询的时候重新评估，可以认为这是“运行时优化”。

&nbsp;&nbsp;&nbsp;&nbsp;**MySQL能够处理的一些优化类型**：
- 重新定义关联表的顺序
- 将外连接转化成内连接
- 使用等价变换规则
- 优化COUNT()、MIN()和MAX()
- 预估并转化为常数表达式
- 覆盖索引扫描
- 子优化查询
- 提前终止查询
- 等值传播
- 列表IN()的比较

---
&nbsp;&nbsp;&nbsp;&nbsp;想要获得高性能的查询效果，**查询优化、索引优化、库表结构优化**需要齐头并进，一个不落。

&nbsp;&nbsp;&nbsp;&nbsp;当一个查询性能很低下时，可以**查询慢日志**，检查程序是否检索了大量超过需要的数据，MySQL服务器层是否分析大量超过需要的数据行；还可以用**Explain检查查询**是否建立索引或者没有使用索引。然后通过发现的问题进行性能改进。
